<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.8">
<title>Batch Layer</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock pre.nowrap,.literalblock pre.nowrap pre,.listingblock pre.nowrap,.listingblock pre.nowrap pre{white-space:pre;word-wrap:normal}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #dddddf}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-right">
<div id="header">
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="#guide-batch-layer.asciidoc">Batch Layer</a>
<ul class="sectlevel1">
<li><a href="#guide-batch-layer.asciidoc_batch-architecture">Batch architecture</a>
<ul class="sectlevel2">
<li><a href="#guide-batch-layer.asciidoc_layering">Layering</a></li>
<li><a href="#guide-batch-layer.asciidoc_batch-administration-and-execution">Batch administration and execution</a></li>
</ul>
</li>
<li><a href="#guide-batch-layer.asciidoc_implementation">Implementation</a>
<ul class="sectlevel2">
<li><a href="#guide-batch-layer.asciidoc_main-challenges">Main Challenges</a></li>
<li><a href="#guide-batch-layer.asciidoc_setup">Setup</a></li>
<li><a href="#guide-batch-layer.asciidoc_example-batch">Example-Batch</a></li>
<li><a href="#guide-batch-layer.asciidoc_restarts">Restarts</a></li>
<li><a href="#guide-batch-layer.asciidoc_chunk-processing">Chunk Processing</a></li>
<li><a href="#guide-batch-layer.asciidoc_tasklet-based-processing">Tasklet based Processing</a></li>
<li><a href="#guide-batch-layer.asciidoc_exception-handling">Exception Handling</a></li>
<li><a href="#guide-batch-layer.asciidoc_listeners">Listeners</a></li>
<li><a href="#guide-batch-layer.asciidoc_parameters">Parameters</a></li>
<li><a href="#guide-batch-layer.asciidoc_performance-tuning">Performance Tuning</a></li>
<li><a href="#guide-batch-layer.asciidoc_testing">Testing</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<!-- toc disabled -->
<h1 id="guide-batch-layer.asciidoc" class="sect0">Batch Layer</h1>
<div class="paragraph">
<p>We understand batch processing as bulk-oriented, non-interactive, typically long running execution of tasks. For simplicity we use the term batch or batch job for such tasks in the following documentation.</p>
</div>
<div class="paragraph">
<p>devonfw uses <a href="http://projects.spring.io/spring-batch/">Spring Batch</a> as batch framework.</p>
</div>
<div class="paragraph">
<p>This guide explains how Spring Batch is used in devonfw applications. Please note that it is not yet fully consistent concerning batches with the sample application. You should adhere to this guide by now.</p>
</div>
<div class="sect1">
<h2 id="guide-batch-layer.asciidoc_batch-architecture">Batch architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this chapter we will describe the overall architecture (especially concerning layering) and how to administer batches.</p>
</div>
<div class="sect2">
<h3 id="guide-batch-layer.asciidoc_layering">Layering</h3>
<div class="paragraph">
<p>Batches are implemented in the batch layer. The batch layer is responsible for batch processes, whereas the business logic is implemented in the logic layer. Compared to the <a href="#guide-service-layer.asciidoc">service layer</a> you may understand the batch layer just as a different way of accessing the business logic.
From a component point of view each batch is implemented as a subcomponent in the corresponding business component.
The business component is defined by the <a href="#architecture.asciidoc">business architecture</a>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s make an example for that. The sample application implements a batch for exporting bills. This <em>billExport</em> belongs to the salesmanagement business component.
So the <em>billExport</em> is implemented in the following package:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>&lt;basepackage&gt;.salesmanagement.batch.impl.billexport.*</code></pre>
</div>
</div>
<div class="paragraph">
<p>Batches should invoke use cases in the logic layer for doing their work.
Only "batch specific" technical aspects should be implemented in the batch layer.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Example:
For a batch, which imports product data from a CSV file, this means that all code for actually reading and parsing the CSV input file is implemented in the batch layer.
The batch calls the use case "create product" in the logic layer for actually creating the products for each line read from the CSV input file.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-batch-layer.asciidoc_-accessing-data-access-layer">Accessing data access layer</h4>
<div class="paragraph">
<p>In practice it is not always appropriate to create use cases for every bit of work a batch should do. Instead, the data access layer can be used directly.
An example for that is a typical batch for data retention which deletes out-of-time data.
Often deleting out-dated data is done by invoking a single SQL statement. It is appropriate to implement that SQL in a <a href="#guide-repository.asciidoc">Repository</a> or <a href="#guide-dao.asciidoc">DAO</a> method and call this method directly from the batch.
But be careful that this pattern is a simplification which could lead to business logic cluttered in different layers which reduces maintainability of your application.
It is a typical design decision you have to take when designing your specific batches.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="guide-batch-layer.asciidoc_batch-administration-and-execution">Batch administration and execution</h3>
<div class="sect3">
<h4 id="guide-batch-layer.asciidoc_starting-and-stopping-batches">Starting and Stopping Batches</h4>
<div class="paragraph">
<p>Spring Batch provides a simple command line API for execution and parameterization of batches, the <code>CommandLineJobRunner</code>. It is not yet fully compatible with Spring Boot, however. For those using Spring Boot, devonfw provides the <code>SpringBootBatchCommandLine</code> with similar functionalities.</p>
</div>
<div class="paragraph">
<p>Both execute batches as a "simple" standalone process (instantiating a new JVM and creating a new ApplicationContext).</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-batch-layer.asciidoc_starting-a-batch-job">Starting a Batch Job</h4>
<div class="paragraph">
<p>For starting a batch job, the following parameters are required:</p>
</div>
<div class="sect4">
<h5 id="guide-batch-layer.asciidoc_jobpaths">jobPath(s)</h5>
<div class="paragraph">
<p>The location of the JavaConfig classes (usually annotated with <code>@Configuration</code> or <code>@SpringBootApplication</code>) and/or XML files that will be used to create an <code>ApplicationContext</code>.</p>
</div>
<div class="paragraph">
<p>The CommandLineJobRunner only accepts one class/file, which must contain everything needed to run a job (potentially by referencing other classes/files), the SpringBootBatchCommandLine, however, expects that there are two paths given: one for the general batch setup and one for the XML file containing the batch job to be executed.</p>
</div>
<div class="paragraph">
<p>There is an example of a general batch setup for Spring Boot in the <a href="https://github.com/devonfw/my-thai-star/tree/develop/java/mtsj/batch">my-thai-star batch module</a>. The main class is <code>SpringBootBatchApp</code>, which also imports the general configuration class introduced in the chapter on the <a href="#guide-batch-layer.asciidoc_general-configuration">general configuration</a>. Note that <code>SpringBootBatchApp</code> deactivates the evaluation of annotations used for authorization, especially the <code>@RolesAllowed</code> annotation. You should of course make sure that only authorized users can start batches, but once the batch is started there is usually no need to check any authorization.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-batch-layer.asciidoc_jobname">jobName</h5>
<div class="paragraph">
<p>The name of the job to be run.</p>
</div>
<div class="paragraph">
<p>All arguments after the job name are considered to be job parameters and must be in the format of <code>name=value</code>:</p>
</div>
<div class="paragraph">
<p>Example for the CommandLineJobRunner:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java org.springframework.batch.core.launch.support.CommandLineJobRunner classpath:config/app/batch/beans-billexport.xml billExportJob -outputFile=file:out.csv date(date)=2015/12/20</pre>
</div>
</div>
<div class="paragraph">
<p>Example for the SpringBootBatchCommandLine:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java com.devonfw.module.batch.common.base.SpringBootBatchCommandLine com.devonfw.application.mtsj.SpringBootBatchApp classpath:config/app/batch/beans-billexport.xml billExportJob -outputFile=file:out.csv date(date)=2015/12/20</pre>
</div>
</div>
<div class="paragraph">
<p>The date parameter will be explained in the section on <a href="#guide-batch-layer.asciidoc_parameters">parameters</a>.</p>
</div>
<div class="paragraph">
<p>Note that when a batch is started with the same parameters as a previous execution of the same batch job, the new execution is considered a restart, see <a href="#guide-batch-layer.asciidoc_restarts">restarts</a> for further details. Parameters starting with a "-" are ignored when deciding whether an execution is a restart or not (so called non identifying parameters).</p>
</div>
<div class="paragraph">
<p>When trying to restart a batch that was already complete, there will either be an exception (message: <code>"A job instance already exists and is complete for parameters={&#8230;&#8203;}.  If you want to run this job again, change the parameters."</code>) or the batch will simply do nothing (might happen when no or only non identifying parameters are set; in this case the console log contains the following message for every step: <code>"Step already complete or not restartable, so no action to execute: &#8230;&#8203;"</code>).</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-batch-layer.asciidoc_stopping-a-job">Stopping a Job</h4>
<div class="paragraph">
<p>The command line option to stop a running execution is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java org.springframework.batch.core.launch.support.CommandLineJobRunner classpath:config/app/batch/beans-billexport.xml –stop billExportJob</pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java com.devonfw.module.batch.common.base.SpringBootBatchCommandLine com.devonfw.application.mtsj.SpringBootBatchApp classpath:config/app/batch/beans-billexport.xml billExportJob –stop</pre>
</div>
</div>
<div class="paragraph">
<p>Note that the job is not shutdown immediately, but might actually take some time to stop.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-batch-layer.asciidoc_scheduling">Scheduling</h4>
<div class="paragraph">
<p>In real world scheduling of batches is not as simple as it first might look like.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Multiple batches have to be executed in order to achieve complex tasks. If one of those batches fails the further execution has to be stopped and operations should be notified for example.</p>
</li>
<li>
<p>Input files or those created by batches have to be copied from one node to another.</p>
</li>
<li>
<p>Scheduling batch executing could get complex easily (quarterly jobs, run job on first workday of a month, &#8230;&#8203;)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For devonfw we propose the batches themselves should not mess around with details of batch administration.
Likewise your application should not do so.</p>
</div>
<div class="paragraph">
<p>Batch administration should be externalized to a dedicated batch administration service or scheduler.
This service could be a complex product or a simple tool like cron. We propose <a href="http://rundeck.org">Rundeck</a> as an open source job scheduler.</p>
</div>
<div class="paragraph">
<p>This gives full control to operations to choose the solution which fits best into existing administration procedures.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="guide-batch-layer.asciidoc_implementation">Implementation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this chapter we will describe how to properly setup and implement batches.</p>
</div>
<div class="sect2">
<h3 id="guide-batch-layer.asciidoc_main-challenges">Main Challenges</h3>
<div class="paragraph">
<p>At a first glimpse, implementing batches is much like implementing a backend for client processing.
There are, however, some points at which batches have to be implemented totally different. This is especially true if large data volumes are to be processed.</p>
</div>
<div class="paragraph">
<p>The most important points are:</p>
</div>
<div class="sect3">
<h4 id="guide-batch-layer.asciidoc_transaction-handling">Transaction handling</h4>
<div class="paragraph">
<p>For processing request made by clients there is usually one transaction for each request. If anything goes wrong, the transaction is rolled back and all changes are reverted.</p>
</div>
<div class="paragraph">
<p>A naive approach for batches would be to execute a whole batch in one single transaction so that if anything goes wrong, all changes are reverted and the batch could start from scratch. For processing large amounts of data, this is technically not feasible, because the database system would have to be able to undo every action made within this transaction. And the space for storing the undo information needed for this (the so called "undo tablespace") is usually quite limited.</p>
</div>
<div class="paragraph">
<p>So there is a need of short running transactions. To help programmers to do so, Spring Batch offers the so called chunk processing which will be explained <a href="#guide-batch-layer.asciidoc_chunk-processing">here</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-batch-layer.asciidoc_restarting-batches">Restarting Batches</h4>
<div class="paragraph">
<p>In client processing mode, when an exception occurs, the transaction is rolled back and there is no need to worry about data inconsistencies.</p>
</div>
<div class="paragraph">
<p>This is not true for batches however, due to the fact that you usually can&#8217;t have just one transaction. When an unexpected error occurs and the batch aborts, the system is in a state where the data is partly processed and partly not and there needs to be some sort of plan on how to continue from there.</p>
</div>
<div class="paragraph">
<p>Even if a batch was perfectly reliable, there might be errors that are not under the control of the application, e.g. lost connection to the database, so that there is always a need for being able to restart.</p>
</div>
<div class="paragraph">
<p>The section on <a href="#guide-batch-layer.asciidoc_restarts">restarts</a> describes how to design a batch that is restartable. What&#8217;s important is that a programmer has to invest some time upfront for a batch to be able restart after aborts.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-batch-layer.asciidoc_exception-handling-in-batches">Exception handling in Batches</h4>
<div class="paragraph">
<p>The problem with exception handling is that a single record can cause a whole batch to fail and many records will remain unprocessed. In contrast to this, in client processing mode when processing fails this usually affects only one user.</p>
</div>
<div class="paragraph">
<p>To prevent this situation, Spring Batch allows to skip data when certain exceptions occur. However, the feature should not be misused in a way that you just skip all exceptions independently of their cause.</p>
</div>
<div class="paragraph">
<p>So when implementing a batch, you should think about what exceptional situations might occur and how to deal with that and weather it is okay to skip those exceptions or not. When an unexpected exception occurs, the batch should still fail so that this exception is not ignored but its causes are analyzed.</p>
</div>
<div class="paragraph">
<p>Another way of handling exceptions in batches is retrying: Simply try to process the data once more and hope that everything works well this time. This approach often works for database problems, e.g. timeouts.</p>
</div>
<div class="paragraph">
<p>The section on <a href="#guide-batch-layer.asciidoc_exception-handling">exception handling</a> explains skipping and retrying in more detail.</p>
</div>
<div class="paragraph">
<p>Note that exceptions are another reason why you should not execute a whole batch in one transaction. If anything goes wrong, you could either rollback the transaction and start the batch from scratch or you could manually revert all relevant changes. Both are not very good solutions.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-batch-layer.asciidoc_performance-issues">Performance issues</h4>
<div class="paragraph">
<p>In client processing mode, optimizing throughput (and response times) is an important topic as well, of course.</p>
</div>
<div class="paragraph">
<p>However, a performance that is still considered okay for client processing might be problematic for batches as these usually have to process large volumes of data and the time for their execution is usually quite limited (batches are often executed at night when no one is using the application).</p>
</div>
<div class="paragraph">
<p>An example: If processing the data of one person takes a second, this is usually still considered OK for client processing (even though performance could be better). However if a batch has to process the data of 100.000 persons in one night and is not executed with multiple threads, this takes roughly 28 hours, which is by far too much.</p>
</div>
<div class="paragraph">
<p>The section on <a href="#guide-batch-layer.asciidoc_performance-tuning">performance</a> contains some tips on how to deal with performance problems.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="guide-batch-layer.asciidoc_setup">Setup</h3>
<div class="sect3">
<h4 id="guide-batch-layer.asciidoc_database">Database</h4>
<div class="paragraph">
<p>Spring Batch needs some meta data tables for monitoring batch executions and for restoring state for <a href="#guide-batch-layer.asciidoc_restarts">restarts</a>. Detailed description about needed tables, sequences and indexes can be found in <a href="http://docs.spring.io/spring-batch/reference/html/metaDataSchema.html">Spring Batch - Reference Documentation: Appendix B. Meta-Data Schema</a>.</p>
</div>
<div class="paragraph">
<p>It is not recommended to add additional meta data tables, because this easily leads to inconsistencies with what is stored in those tables maintained by Spring Batch.
You should rather try to extract all needed information out of the standard tables in case the standard API (especially <code>JobRepository</code> and <code>JobExplorer</code>, see below) does not fit your needs.</p>
</div>
<div class="sect4">
<h5 id="guide-batch-layer.asciidoc_failure-information">Failure information</h5>
<div class="paragraph">
<p><code>BATCH_JOB_EXECUTION.EXIT_MESSAGE</code> and <code>BATCH_STEP_EXECUTION.EXIT_MESSAGE</code> store a detailed description of how the job exited. In the case of failure, this might include as much of the stack trace as is possible.
<code>BATCH_STEP_EXECUTION_CONTEXT.SHORT_CONTEXT</code> stores a stringified version of the step&#8217;s <code>ExecutionContext</code> (see <a href="#guide-batch-layer.asciidoc_saving-and-restoring-state">saving and restoring state</a>, the rest is stored in a BLOB if needed).
The default length of those columns in the sample schema scripts is <code>2500</code>.</p>
</div>
<div class="paragraph">
<p>It is good to increase the length of those columns as far as the database allows it to make it easier to find out which exception failed a batch (not every exception causes a failure, see <a href="#guide-batch-layer.asciidoc_exception-handling">exception handling</a>). Some JDBC drivers cast CLOBs to string automatically. If this is the case, you can use CLOBs instead.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-batch-layer.asciidoc_general-configuration">General Configuration</h4>
<div class="paragraph">
<p>For configuring batches, we recommend not to use annotations (would not work very well for batches) or JavaConfig, but XML, because this makes the whole batch configuration more transparent, as its structure and implementing beans are immediately visible. Moreover the Spring Batch documentation focuses rather on XML based configurations than on JavaConfig.</p>
</div>
<div class="paragraph">
<p>For explanations on how these XML files are build in general, have a look at the <a href="http://docs.spring.io/spring-framework/docs/current/spring-framework-reference/html/beans.html#beans-factory-metadata">spring documentation</a>.</p>
</div>
<div class="paragraph">
<p>There is, however, some general configuration needed for all batches, for which we use JavaConfig, as it is also used for the setup of all other layers. You can find an example of such a configuration in the <code>samples/core</code> project: <code>BeansBatchConfig</code>. In this section, we will explain the most important parts of this class.</p>
</div>
<div class="paragraph">
<p>The <code>jobRepository</code> is used to update the meta data tables.</p>
</div>
<div class="paragraph">
<p>The database type can optionally be set on the <code>jobRepository</code> for correctly handling database specific things using the <code>setDatabaseType</code> method. Possible values are oracle, mysql, postgres etc.</p>
</div>
<div class="paragraph">
<p>If the size of all three columns, which by default have a length limitation of 2500, has been increased as proposed <a href="#guide-batch-layer.asciidoc_failure-information">here</a>, the property maxVarCharLength should be adjusted accordingly using the corresponding setter method in order to actually utilize the additional space.</p>
</div>
<div class="paragraph">
<p>The <code>jobExplorer</code> offers methods for reading from the meta data tables in addition to those methods provided by the <code>jobRepository</code>, e.g. getting the last executions of a batch.</p>
</div>
<div class="paragraph">
<p>The <code>jobLauncher</code> is used to actually start batches.</p>
</div>
<div class="paragraph">
<p>We use our own implementation (<code>JobLauncherWithAdditionalRestartCapabilities</code>) here, which can be found in the module <code>modules/batch</code> (<code>devon4j-batch</code>). It enables a special form of restarting a batch ("restart from scratch", see the section on <a href="#guide-batch-layer.asciidoc_restarts">restarts</a> for further details).</p>
</div>
<div class="paragraph">
<p>The <code>jobRegistry</code> is basically a map, which contains all batch jobs. It is filled by the bean of type <code>JobRegistryBeanPostProcessor</code> automatically.</p>
</div>
<div class="paragraph">
<p>A <code>JobParametersIncremeter</code> (bean <code>incrementer</code>) can be used to generate unique parameters, see <a href="#guide-batch-layer.asciidoc_restarts">restarts</a> and <a href="#guide-batch-layer.asciidoc_parameters">parameters</a> for further details. It should be configured manually for each batch job, see example batch below, otherwise exceptions might occur when starting batches.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="guide-batch-layer.asciidoc_example-batch">Example-Batch</h3>
<div class="paragraph">
<p>As already mentioned, every batch job consists of one or more batch steps, which internally either use chunk processing or tasklet based processing.</p>
</div>
<div class="paragraph">
<p>Our bill export batch job consists of the following to steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Read all (not processed) bills from the database, mark them as processed (additional attribute) and write them into a CSV file (to be further processed by other systems). This step is implemented using chunk processing (see <a href="#guide-batch-layer.asciidoc_chunk-processing">chunk processing</a>).</p>
</li>
<li>
<p>Delete all bill from the database which are marked as processed. This step is implemented in a tasklet (see <a href="#guide-batch-layer.asciidoc_tasklet-based-processing">tasklet based processing</a>).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Note that you could also delete the bills directly. However, for being able to demonstrate tasklet based processing, we have created a separate step here.</p>
</div>
<div class="paragraph">
<p>Also note that in real systems you would usually create a backup of data as important as bills, which is not done here.</p>
</div>
<div class="paragraph">
<p>The <a href="https://github.com/devonfw/my-thai-star/blob/develop/java/mtsj/batch/src/main/resources/config/app/batch/beans-billexport.xml">beans-billexport.xml</a> configures the batch for exporting the bills.</p>
</div>
<div class="paragraph">
<p>As you can see, there is a job element (<code>billExportJob</code>), which contains the two step elements (<code>createCsvFile</code> and <code>deleteBills</code>). Note that for every step you have to explicitly specify which step comes next (using the next attribute), unless it is the last step.</p>
</div>
<div class="paragraph">
<p>The step elements always contains a tasklet element, even if chunk processing is used. The transaction-attributes element is especially used to set timeout of transactions (in seconds). Note that there is usually more than one transaction per step (see below).</p>
</div>
<div class="paragraph">
<p>What follows is either a chunk element with <code>ItemReader</code>, <code>ItemProcessor</code>, <code>ItemWriter</code> and a commit interval (see <a href="#guide-batch-layer.asciidoc_chunk-processing">chunk processing</a>) or the tasklet element containing a reference to a tasklet.</p>
</div>
<div class="paragraph">
<p>In the example above the <code>ItemReader</code> named <code>unprocessedBillsReader</code> always reads 1000 ids of unprocessed bills (via a DAO) and returns them one after another. The <code>ItemProcessor</code> <code>processedMarker</code> reads the corresponding bills from the database (see <a href="#guide-batch-layer.asciidoc_chunk-processing">chunk processing</a> why we do not read them directly in the <code>ItemReader</code>) and marks them as processed. The <code>ItemWriter</code> <code>csvFileWriter</code> (see below on how this writer is configured) writes them to a CSV file. The path of this file is provided as batch parameter (<code>outputFile</code>).</p>
</div>
<div class="paragraph">
<p>The <code>tasklet</code> <code>billsDeleter</code> deletes all processed bills (10.000 in one transaction).</p>
</div>
<div class="paragraph">
<p>The <code>chunkLoggingListener</code>, which is also used in the example above, can be utilized for all chunk steps to log exceptions together with the items where these exceptions occurred (see <a href="#guide-batch-layer.asciidoc_listeners">listeners</a> for further details on listeners). It&#8217;s implementation can be found in the module modules/batch. Note that classes used for items have to have an appropriate <code>toString()</code> method in order for this listener to be useful.</p>
</div>
</div>
<div class="sect2">
<h3 id="guide-batch-layer.asciidoc_restarts">Restarts</h3>
<div class="paragraph">
<p>A batch execution is considered a restart, if it was run already (with the same parameters) and there was a (non skippable) failure or the batch has been stopped.</p>
</div>
<div class="paragraph">
<p>There are basically two ways to do a restart:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Undo all changes and restart from scratch.</p>
</li>
<li>
<p>Restore the state of that batch at the time the error occurred and continue processing.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The first approach has two major disadvantages:
One is that depending on what the batch does, reverting all of its changes can get quite complex. And you easily end up having implemented a batch that is restartable, but not if it fails in the wrong step.</p>
</div>
<div class="paragraph">
<p>The second disadvantage is that if a batch runs for several hours and then it fails it has to start all over again. And as the time for executing batches is usually quite limited, this can be problematic.</p>
</div>
<div class="paragraph">
<p>If reverting all changes is as easy as deleting all files in a given directory or something like that and the expected duration for an execution of the batch is rather short, you might consider the option of always starting at the beginning, otherwise you shouldn’t.</p>
</div>
<div class="paragraph">
<p>Spring Batch supports implementing the second option. By default, if a batch is restarted with the same parameters as a previous execution of this batch, then this new execution continues processing at the step where the last execution was stopped or failed. If the last execution was already complete, an exception is raised.</p>
</div>
<div class="paragraph">
<p>The step itself has to be implemented in a way so that it can restore its internal state, which is the main drawback of this second option.</p>
</div>
<div class="paragraph">
<p>However, there are 'standard implementations' that are capable of doing so and these can easily be adapted to your needs. They are introduced in the section on <a href="#guide-batch-layer.asciidoc_chunk-processing">chunk processing</a>.</p>
</div>
<div class="paragraph">
<p>For instructing Spring Batch to always restart a batch at the very beginning even though there has been an execution of this batch with the same parameters already, set the <code>restartable</code> attribute of the <code>Job</code> element to false.</p>
</div>
<div class="paragraph">
<p>By default, setting this attribute to false means that the batch is not restartable (i.e. it cannot be started with the same parameters once more). It would raise an error if there was attempt to do so, so that it cannot be restarted where it left off.</p>
</div>
<div class="paragraph">
<p>We use our own <code>JobLauncher</code> (<code>JobLauncherWithAdditionalRestartCapabilities</code>) as described in the section on the <a href="#guide-batch-layer.asciidoc_general-configuration">general configuration</a> to modify this behavior so that those batches are always restarted from the first step on by adding an extra parameter (instead of raising an exception), so that you do not have to take care of that yourself. So don&#8217;t think of a batch marked with <code>restartable="false"</code> as a batch that is not restartable (as most people would probably assume just looking at the attribute) but as a batch that restarts always from the first step on.</p>
</div>
<div class="paragraph">
<p>Note that if a batch is restartable by restoring its internal state, it might not work correctly if the batch is started with different parameters after it failed, which usually comes down to the same thing as restating it from scratch. So, the batch has to be restarted and completed successfully before executing the next regular 'run'. When scheduling batches, you should make that sure.</p>
</div>
</div>
<div class="sect2">
<h3 id="guide-batch-layer.asciidoc_chunk-processing">Chunk Processing</h3>
<div class="paragraph">
<p>Chunk processing is item based processing. Items can be bills, persons or whatever needs to be processed. Those items are grouped into chunks of a fixed size and all items within such a chunk are processed in one transaction. There is not one transaction for every single (small) item because there would be too many commits which degrades performance.</p>
</div>
<div class="paragraph">
<p>All items of a chunk are read by an <code>ItemReader</code> (e.g. from a file or from database), processed by an <code>ItemProcessor</code> (e.g. modified or converted) and written out as a whole by an <code>ItemWriter</code> (e.g. to a file or to database).</p>
</div>
<div class="paragraph">
<p>The size of a chunk is also called commit interval. One has to be careful , while choosing a large chunk size: When a skip or retry occurs for a single item (see <a href="#guide-batch-layer.asciidoc_exception-handling">exception handling</a>), the current transaction has to be rolled back and all items of the chunk have to be reprocessed. This is especially a problem when skips and retries occur more often and results in long runtimes.</p>
</div>
<div class="paragraph">
<p>The most important advantages of chunk processing are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>good trade-off between size and number of transactions (configurable via commit size)</p>
</li>
<li>
<p>transaction timeouts that do not have to be adapted for larger amounts of data that needs to be processed (as there is always one transaction for a fixed number of items)</p>
</li>
<li>
<p>an exception handling that is more fain-grained than aborting/restarting the whole batch (item based skipping and retrying, see <a href="#guide-batch-layer.asciidoc_exception-handling">exception handling</a>)</p>
</li>
<li>
<p>logging items where exceptions occurred (which makes failure analysis much more easy)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that you could actually achieve similar results using <a href="#guide-batch-layer.asciidoc_tasklet-based-processing">tasklets</a> as described below. However, you would have to write many lines of additional code whereas you get these advantages out of the box using chunk processing (logging exceptions and items where these exceptions occurred is an extension, see <a href="#guide-batch-layer.asciidoc_example-batch">example batch</a>).</p>
</div>
<div class="paragraph">
<p>Also note that items should not be too "big". For example, one might consider processing all bills within one month as one item. However, doing so you would not have those advantages any more. For instance, you would have larger transactions, as there are usually quite a lot of bills per month or payment method and if an exception occurs, you would not know which bill actually caused the exception. Additionally you would lose control of commit size, since one commit would process many bills hard coded and you cannot choose smaller chuncks.</p>
</div>
<div class="paragraph">
<p>Nevertheless, there are sometimes, situations where you cannot further "divide" items, e.g. when these are needed for one single call to an external system (e.g. for creating a PDF of all bills within a certain month, if PDFs are created by an external system). In this case you should do as much of the processing as possible on the basis of "small" items and then add an extra step to do what cannot be done based on these "small" items.</p>
</div>
<div class="sect3">
<h4 id="guide-batch-layer.asciidoc_itemreader">ItemReader</h4>
<div class="paragraph">
<p>A reader has to implement the <code>ItemReader</code> interface, which has the following method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public T read() throws Exception;</code></pre>
</div>
</div>
<div class="paragraph">
<p>T is a type parameter of the <code>ItemReader</code> interface to be replaced with the type of items to be read.</p>
</div>
<div class="paragraph">
<p>The method returns all items (one at a time) that need to be processed or null if there are no more items.</p>
</div>
<div class="paragraph">
<p>If an exception occurs during read, Spring Batch cannot tell which item caused the exception (as it has not been read yet). That is why a reader should contain as little processing logic as possible, minimizing the potential for failures.</p>
</div>
<div class="sect4">
<h5 id="guide-batch-layer.asciidoc_caching">Caching</h5>
<div class="paragraph">
<p>By default, all items read by an <code>ItemReader</code> are cached by Spring Batch. This is useful because when a skippable exception occurs during processing of a chunk, all items (or at least those, that did not cause the exception) have to be reprocessed. These items are not read twice but taken from the cache then.</p>
</div>
<div class="paragraph">
<p>This is often necessary, because if a reader saves it&#8217;s current state in member variables (e.g. the current position within a list of items) or uses some sort of cursor, these will be updated already and the next calls of the read method would deliver the next items ready and not those that have to be reprocessed.</p>
</div>
<div class="paragraph">
<p>However this also means that when the items read by an <code>ItemReader</code> are entities, these might be detached, because these might have been read in a different transaction. In some standard implementations Spring Batch even manually detaches entities in <code>ItemReaders</code>.</p>
</div>
<div class="paragraph">
<p>In case these entities are to be modified it is a good practice that the <code>ItemReader</code> only reads IDs and the <code>ItemProcessor</code> loads the entities for these IDs to avoid the problem.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-batch-layer.asciidoc_reading-from-transactional-queues">Reading from Transactional Queues</h5>
<div class="paragraph">
<p>In case the reader reads from a transactional queue (e.g. using JMS), you must not use caching, because then an item might get processed twice: Once from cache and once from queue to where it has been returned after the rollback. To achieve this, set <code>reader-transactional-queue="true"</code> in the chunk element in the step definition.</p>
</div>
<div class="paragraph">
<p>Moreover the <code>equals</code> and <code>hashCode</code> methods of the class used for items have to be appropriately implemented for Spring Batch to be able to identify items that were processed before unsuccessfully (causing a rollback and thereby returning them to the queue). Otherwise the batch might be caught in an infinite loop trying to process the same item over and over again (e.g. when the item is about to be skipped, see <a href="#guide-batch-layer.asciidoc_exception-handling">exception handling</a>).</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-batch-layer.asciidoc_reading-from-the-database">Reading from the Database</h5>
<div class="paragraph">
<p>When selecting data from a database, there is usually some sort of cursor used. One challenge is to make this cursor not participate in the chunk&#8217;s transaction, because it would be closed after the first chunk.</p>
</div>
<div class="paragraph">
<p>We will show how to use JDBC based cursors for <code>ItemReader</code> implementations in later releases of this documentation.</p>
</div>
<div class="paragraph">
<p>For JPA/JPQL based queries, cursors cannot be used, because JPA does not know of the concept of a cursor. Instead it supports pagination as introduced in the chapter on the data access layer, which can be used for this purpose as well. Note that pagination requires the result set to be sorted in an unambiguous order to work reliably. The order itself is irrelevant as long as it does not change (you can e.g. sort the entities by their primary key).</p>
</div>
<div class="paragraph">
<p>An <code>ItemReader</code> using pagination should inherit from the <code>AbstractPagingItemReader</code>, which already provides most of the needed functionality. It manages the internal state, i.e. the current position, which can be correctly restored after a restart (when using an unambiguous order for the result set).</p>
</div>
<div class="paragraph">
<p>Classes inheriting from <code>AbstractPagingItemReader</code> must implement two methods.</p>
</div>
<div class="paragraph">
<p>The method <code>doReadPage()</code> performs the actual read of a page. The result is not returned (return type is void) but used to replace the content of the 'results' instance variable (type: List).</p>
</div>
<div class="paragraph">
<p>Due to our layering concept and the persistence layer being the only place where access to the database should take place, you should not directly execute a query in this method, but call a DAO, which itself executes the query (using pagination).</p>
</div>
<div class="paragraph">
<p><code>AbstractPagingItemReader</code> provides methods for finding out the current position: use <code>getPage()</code> for the current page and <code>getPageSize()</code> for the (max.) page size. These values should be passed to the DAO as parameters. Note that the <code>AbstractPagingItemReader</code> starts counting pages from zero, whereas the <code>PaginationTo</code> used for pagination (retrieved by calling <code>SearchCriteriaTo.getPagination()</code>) starts counting from one, which is why you always have to increment the page number by one.</p>
</div>
<div class="paragraph">
<p>The second method is <code>doJumpToPage(int)</code>, which usually only requires an empty implementation.</p>
</div>
<div class="paragraph">
<p>Furthermore, you need to set the property <code>pageSize</code>, which specifies how many items should be read at once. A page size that is as big as the commit interval usually results in the best performance.</p>
</div>
<div class="paragraph">
<p>The approach of using pagination for <code>ItemReader</code> should not be used when items (usually entities) are added or removed or modified by the batch step itself or in parallel with the execution of the batch step so that the order changes, e.g. by other batches or due to operations started by clients (i.e. if the batch is executed in online mode). In this case there might be items processed twice or not processed at all. Be aware that due to hibernate&#8217;s Hi/Lo-Algorithm newer entities could get lower IDs than existing IDs and you probably will not process all entities if you rely on strict ID monotony!</p>
</div>
<div class="paragraph">
<p>A simple solution for such scenarios would be to introduce a new flag 'processed' for the entities read if that is an option (as it is also done in the example batch). The query should be rewritten then so that only unprocessed items are read (additionally limiting the result set size to the number of items to be processed in the current chunk, but not more).</p>
</div>
<div class="paragraph">
<p>Note that most of the standard implementations provided by Spring Batch do not fit to the layering approach in devonfw applications, as these mostly require direct access to an <code>EntityManager</code> or a JDBC connection for example.  You should think twice when using them and not break the layering concept.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-batch-layer.asciidoc_reading-from-files">Reading from Files</h5>
<div class="paragraph">
<p>For reading simply structured files, e.g. for those in which every line corresponds to an item to be processed by the batch, the <code>FlatFileItemReader</code> can be used. It requires two properties to be set: The first one the <code>LineMapper</code> (property <code>lineMapper</code>), which is used to convert a line (i.e. a String) to an item. It is a very simple interface which will not be discussed in more detail here. The second one is the resource, which is actually the file to be read. When set in the XML, it is sufficient to specify the path with a "file:" in front of it if it is a normal file from the file system.</p>
</div>
<div class="paragraph">
<p>In addition to that, the property <code>linesToSkip</code> (integer) can be set to skip headers for example. For reading more than one line before for creating an item, a <code>RecordSeparatorPolicy</code> can be used, which will not be discussed in more detail here, too. By default, all lines starting with a '#' will be considered to be a comment, which can be changed by changing the comment property (string array). The encoding property can be used to set the encoding. A <code>FlatFileItemReader</code> can restore its state after restarts.</p>
</div>
<div class="paragraph">
<p>For reading XML files, you can use the <code>StaxEventItemReader</code> (StAX is an alternative to DOM and SAX), which will not be discussed in further detail here.</p>
</div>
<div class="paragraph">
<p>In case the standard implementations introduced here do not fit your needs, you will need to implement your own <code>ItemReader</code>. If this <code>ItemReader</code> has some internal state (usually stored in member variables), which needs to be restored in case of restarts, see the section on <a href="#guide-batch-layer.asciidoc_saving-and-restoring-state">saving and restoring state</a> for information on how to do this.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-batch-layer.asciidoc_itemprocessor">ItemProcessor</h4>
<div class="paragraph">
<p>A processor must implement the <code>ItemProcessor</code> interface, which has the following method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public O process(I item) throws Exception;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, there are two type parameters involved: one for the type of items received from the <code>ItemReader</code> and one for the type of items passed to the <code>ItemWriter</code>. These can be the same.</p>
</div>
<div class="paragraph">
<p>If an item has been selected by the <code>ItemReader</code>, but there is no need to further process this item (i.e. it should not be passed to the <code>ItemWriter</code>), the <code>ItemProcessor</code> can return null instead of an item.</p>
</div>
<div class="paragraph">
<p>Strictly interpreting chunk processing, the <code>ItemProcessor</code> should not modify anything but should only give instructions to the <code>ItemWriter</code> on how to do modifications. For entities however this is not really practical and as it requires no special logic in case of rollbacks/restarts (as all modifications are transactional), it is usually OK to modify them directly.</p>
</div>
<div class="paragraph">
<p>In contrast to this, performing accesses to files or calling external systems should only be done in <code>ItemReader</code>/<code>ItemWriter</code> and the code needed for properly handling failures (restarts for example) should be encapsulated there.</p>
</div>
<div class="paragraph">
<p>It is usually a good practice to make <code>ItemProcessor</code> implementations stateless, as the process method might be called more than once for one item (see the section on <code>ItemReader</code> why). If your ItemProcessor really needs to have some internal state, see <a href="#guide-batch-layer.asciidoc_saving-and-restoring-state">saving and restoring state</a> on how to save and restore the state for restarts.</p>
</div>
<div class="paragraph">
<p>Do not forget to implement use cases instead of implementing everything directly in the ItemProcessor if the processing logic gets more complex.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-batch-layer.asciidoc_itemwriter">ItemWriter</h4>
<div class="paragraph">
<p>A writer has to implement the ItemWriter interface, which has the following method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public void write(List&lt;? extends T&gt; items) Exception;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This method is called at the end of each chunk with a list of all (processed) items. It is not called once for every item, because it is often more efficient doing 'bulk writes', e.g. when writing to files.</p>
</div>
<div class="paragraph">
<p>Note that this method might also be called more than once for one item (see the section on ItemReader&#8217;s why).</p>
</div>
<div class="paragraph">
<p>At the end of the write method, there should always be a flush.</p>
</div>
<div class="paragraph">
<p>When writing to files, this should be obvious, because when a chunks completes, it is expected that all changes are already there in case of restarts, which is not true if these changes were only buffered but have not been written out.</p>
</div>
<div class="paragraph">
<p>When modifying the database, the flush method on the <code>EntityManager</code> should be called, too (via a DAO), because there might be changes not written out yet and therefore constraints were not checked yet. This can be problematic, because Spring Batch considers all exceptions that occur during commit as critical, which is why these exceptions cannot be skipped. You should be careful using deferred constraints for the same reason.</p>
</div>
<div class="sect4">
<h5 id="guide-batch-layer.asciidoc_writing-to-database-or-transactional-queues">Writing to Database or Transactional Queues</h5>
<div class="paragraph">
<p>All changes made which are transactional can be conducted directly, there is no special logic needed for restarts, because these changes are applied if and only if the chunk succeeds.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-batch-layer.asciidoc_writing-to-files">Writing to Files</h5>
<div class="paragraph">
<p>For writing simply structured files, the <code>FlatFileItemWriter</code> can be used. Similar to the FlatFileItemReader it requires the resource (i.e. the file) and a <code>LineAggregator</code> (property <code>lineAggregator</code> instead of the <code>lineMapper</code>) to be set.</p>
</div>
<div class="paragraph">
<p>There are various properties that can be used of which we will only present the most important ones here. As with the FlatFileItemReader, the encoding property is used to set the encoding. A FlatFileHeaderCallback (property headerCallback) can be used to write a header.</p>
</div>
<div class="paragraph">
<p>The <code>FlatFileItemWriter</code> can restore its state correctly after restarts. In case, the files contain too many lines (written out in chunks that did not complete successfully), these lines are removed before continuing execution.</p>
</div>
<div class="paragraph">
<p>For writing XML files, you can use the <code>StaxEventItemWriter</code>, which will not be discussed in further detail here.</p>
</div>
<div class="paragraph">
<p>Just as with <code>ItemReader</code> and <code>ItemProcessor</code>: In case your <code>ItemWriter</code> has some internal state this state is not managed by a standard implementation, see <a href="#guide-batch-layer.asciidoc_saving-and-restoring-state">saving and restoring state</a> on how to make your implementation restartable (restart by restoring the internal state).</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-batch-layer.asciidoc_saving-and-restoring-state">Saving and Restoring State</h4>
<div class="paragraph">
<p>For saving and restoring (in case of restarts) state, e.g. saving and restoring values of member variables, the ItemStream interface should be implemented by the <code>ItemReader</code>/<code>ItemProcessor</code>/<code>ItemWriter</code>, which has the following methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public void open(ExecutionContext executionContext) throws ItemStreamException;
public void update(ExecutionContext executionContext) throws ItemStreamException;
public void close() throws ItemStreamException;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The open method is always called before the actual processing starts for the current step and can be used to restore state when restarting.</p>
</div>
<div class="paragraph">
<p>The <code>ExecutionContext</code> passed in as parameter is basically a map to be used to retrieve values set before the failure. The method <code>containsKey(String)</code> can be used to check if a value for a given key is set. If it is not set, this might be because the current batch execution is no restart or no value has been set before the failure.</p>
</div>
<div class="paragraph">
<p>There are several getter methods for actually retrieving a value for a given key: <code>get(String)</code> for objects (must be serializable), <code>getInt(String)</code>, <code>getLong(String)</code>, <code>getDouble(String)</code> and <code>getString(String)</code>. These values will be the same as after the subsequent call to the update method after the last chunk that completed successfully. Note that if you update the ExecutionContext outside of the update method (e.g. in the read method of an <code>ItemReader</code>), it might contain values set in chunks that did not finish successfully after restarts, which is why you should not do that.</p>
</div>
<div class="paragraph">
<p>So the update method is the right place to update the current state. It is called after each chunk (and before and after each step).</p>
</div>
<div class="paragraph">
<p>For setting values, there are several put methods: <code>put(String, Object)</code>, <code>putInt(String, int)</code>, <code>putLong(String, long)</code>, <code>putDouble(String, double)</code> and <code>putString(String, String)</code>. You can choose keys (<code>String</code>) freely as long as these are unique within the current step.</p>
</div>
<div class="paragraph">
<p>Note that when a skip occurs, the update method is sometimes but not always called, so you should design your code in a way that it can deal with both situations.</p>
</div>
<div class="paragraph">
<p>The close method is usually not needed.</p>
</div>
<div class="paragraph">
<p>Do not misuse the ItemStream interface for purposes other than storing/restoring state. For instance, do not use the update method for flushing, because you will not have the chance to properly handle failure (e.g. skipping). For opening or closing a file handle, you should rather use a StepExecutionListener as introduced in the section on <a href="#guide-batch-layer.asciidoc_listeners">listeners</a>. The state can also be restored in the beforeStep(ExecutionListener) method (instead of the open method).</p>
</div>
<div class="paragraph">
<p>Note that when a batch that always starts from scratch (i.e. the restartable attribute has been set to false for the batch job) is restarted, the ExecutionContext will not contain any state from the previous (failed) execution, so there is no use in storing the state in this case and usually no need to, of course, because the batch will start all over again.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="guide-batch-layer.asciidoc_tasklet-based-processing">Tasklet based Processing</h3>
<div class="paragraph">
<p>Tasklets are the alternative to chunk processing. In the section on <a href="#guide-batch-layer.asciidoc_chunk-processing">chunk processing</a> we already mentioned the advantages of chunk processing as compared to tasklets. However, if only very few data needs to be processed (within one transaction) or if you need to do some sort of bulk operation (e.g. deleting all records from a database table), where the currently processed item does not matter and it is unlikely that a 'fine grained' exception handling will be needed, tasklets might still be considered an option. Note that for the latter use case you should still use more than one transaction, which is possible when using tasklets, too.</p>
</div>
<div class="paragraph">
<p>Tasklets have to implement the interface with the same name, which has the following method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public RepeatStatus execute(StepContribution contribution, ChunkContext chunkContext) throws Exception;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This method might be called several times. Every call is executed inside a new transaction automatically. If processing is not finished yet and the execute method should be called once more, just use RepeatStatus.CONTINUABLE as return value and <code>RepeatStatus.FINISHED</code> otherwise.</p>
</div>
<div class="paragraph">
<p>The <code>StepContribution</code> parameter can be used to set how many items have been processed manually (which is done automatically using chunk processing), there is, however, usually no need to do so.</p>
</div>
<div class="paragraph">
<p>The ChunkContext is similar to the <code>ExecutionContext</code>, but is only used within one chunk. If there is a retry in chunk processing, the same context should be used (with the same state that this context had when the exception occurred).</p>
</div>
<div class="paragraph">
<p>Note that tasklets serve as the basis for chunk processing internally. For chunk processing there is a Spring Batch internal tasklet, which has an execute method that is called for every chunk and itself calls <code>ItemReader</code>, <code>ItemProcessor</code> and <code>ItemWriter</code>.</p>
</div>
<div class="paragraph">
<p>That is the reason why a <code>StepContribution</code> and a <code>ChunkContext</code> are passed to tasklets as parameters, even though they are more useful in chunk processing. Moreover this is also the reason why you have to use the tasklet element in the XML even though you want to specify a step that uses chunk processing (see <a href="#guide-batch-layer.asciidoc_example-batch">the example batch</a>).</p>
</div>
</div>
<div class="sect2">
<h3 id="guide-batch-layer.asciidoc_exception-handling">Exception Handling</h3>
<div class="paragraph">
<p>As already mentioned, in chunk processing you can configure a step so that items are skipped or retried when certain exceptions occur.</p>
</div>
<div class="paragraph">
<p>If retries are exhausted (by default, there is no retry) and the exception that occurred cannot be skipped (by default, no exception can be skipped), the batch will fail (i.e. stop executing).</p>
</div>
<div class="paragraph">
<p>In tasklet based processing this cannot be done, the only chance is to implement the needed logic yourself.</p>
</div>
<div class="sect3">
<h4 id="guide-batch-layer.asciidoc_skipping">Skipping</h4>
<div class="paragraph">
<p>Before skipping items you should think about what to do if a skip occurs. If a skip occurs, the exception will be logged in the server log. However if no one evaluates those logs on a regular basis and informs those who are affected further actions need to take place when implementing the batch.</p>
</div>
<div class="paragraph">
<p>Implement the <code>SkipListener</code> interface to be informed when a skip occurs. For example, you could store a notification or send a message to someone. For skips that occurred in ItemReader&#8217;s there is no information available about the item that was skipped (as it has not been read yet) which is why there should be as little processing logic as possible in an <code>ItemReader</code>. It might also be a reason why you might want to forbid  to skip exceptions that might occur in readers.</p>
</div>
<div class="paragraph">
<p>Do not try to catch skipped exceptions and write something into the database in a new transaction (e.g. a notification) instead of using a SkipListener, because a skipped item might be processed more than once before actually being skipped (for example, if a skippable exception is thrown during a call of an <code>ItemWriter</code>, Spring Batch does not know which item of the current chunk actually caused the exception and therefore has to retry each item separately in order to know which item actually caused the exception).</p>
</div>
<div class="paragraph">
<p>Skippable exception classes can be specified as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">      &lt;batch:chunk ... skip-limit="10"&gt;
         &lt;batch:skippable-exception-classes&gt;
            &lt;batch:include class="..."/&gt;
            &lt;batch:include class="..."/&gt;
            ...
         &lt;/batch:skippable-exception-classes&gt;
      &lt;/batch:chunk&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The attribute skip-limit, which has to be set in case there is any skippable exception class configured, is used to set how many items should be skipped at most. It is useful to avoid situations where many items are skipped but the batch still completes successfully and no one notices this situation.</p>
</div>
<div class="paragraph">
<p>Skippable exception classes are specified by their fully qualified name (e.g. <code>java.lang.Exception</code>), each of such class set in its own include element as shown above. Subclasses of such classes are also skipped.</p>
</div>
<div class="paragraph">
<p>To programmatically decide whether to skip an exception or not, you can set a skip policy as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;batch:chunk ... skip-policy="mySkipPolicy"&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The skip policy (here <code>mySkipPolicy</code>) has to be a bean that implements the interface <code>SkipPolicy</code> with the following method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public boolean shouldSkip(java.lang.Throwable t,
                   int skipCount)
            throws SkipLimitExceededException</code></pre>
</div>
</div>
<div class="paragraph">
<p>To skip the exception and continue processing, just return true and otherwise false.</p>
</div>
<div class="paragraph">
<p>The parameter <code>skipCount</code> can be used for a skip limit. A <code>SkipLimitExceededException</code> should be thrown if there should be no more skips. Note that this method is sometimes called with a skipCount less than zero to test if an exception is skippable in general.</p>
</div>
<div class="paragraph">
<p>When a <code>SkipPolicy</code> is set, the attribute <code>skip-limit</code> and element <code>skippable-exception-classes</code> are ignored.</p>
</div>
<div class="paragraph">
<p>You could of course skip every exception (using <code>java.lang.Exception</code> as skippable exception class). This is, however, not a good practice as it might easily result in an error in the code that is ignored as the batch still completes successfully and everything seems to be fine. Instead, you should think about what kind of exceptions might actually occur, what to do if they occur and if it is OK to skip them. If an unexpected exception occurs, it is usually better to fail the batch execution and analyze the cause of the exception before restarting the batch.</p>
</div>
<div class="paragraph">
<p>Exceptions that can occur in instances of <code>ItemWriter</code> that write something to file should not be skipped unless the <code>ItemWriter</code> can properly deal with that. Otherwise there might be data written out even though the according item is skipped, because operations in the file systems are not transactional.</p>
</div>
<div class="paragraph">
<p>Another situation where skips can be problematic is when calls to external interfaces are being made and these calls change something "on the other side", as these calls are usually not transactional. So be careful using skips here, too.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-batch-layer.asciidoc_retrying">Retrying</h4>
<div class="paragraph">
<p>For some types of exceptions, processing should be retried independently of weather the exception can be skipped or would otherwise fail the batch execution.</p>
</div>
<div class="paragraph">
<p>For example, if there was a database timeout, this might be because there were too many requests at the time the chunk was processed. And it is not unlikely that retrying to successfully complete the chunk would succeed.</p>
</div>
<div class="paragraph">
<p>There are, of course, also exceptions where retrying does not make much sense. E.g. exceptions caused by the business logic should be deterministic and therefore retrying does not make much sense in this case.</p>
</div>
<div class="paragraph">
<p>Nevertheless, retrying every exception results in longer runtime but should in general be considered OK if you do not know which exceptions might occur or do not have the time to think about it.</p>
</div>
<div class="paragraph">
<p>Retryable exception classes can be set similarly to setting skippable exception classes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">      &lt;batch:chunk ... retry-limit="3"&gt;
         &lt;batch:retryable-exception-classes&gt;
            &lt;batch:include class="..."/&gt;
            &lt;batch:include class="..."/&gt;
            ...
         &lt;/batch:retryable-exception-classes&gt;
      &lt;/batch:chunk&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>retry-limit</code> attribute specifies how many times one individual item can be retried, as long as the exception thrown is "retryable".</p>
</div>
<div class="paragraph">
<p>As with skippable exception classes, retryable exception classes are set in include elements and their subclasses are retried, too.</p>
</div>
<div class="paragraph">
<p>To programmatically decide, whether to retry an exception or not, you can use a <code>RetryPolicy</code>, which is not covered in more detail here.</p>
</div>
<div class="paragraph">
<p>Note that even if no retry is configured, an item might nevertheless be processed more than once. This is because if a skippable exception occurs in a chunk, all items of the chunk that did not cause the exception have to reprocessed, which is done in a separate transaction for every item, as the transaction in which these items were processed in the first place was rolled back. And even if the exception is not skippable, there is no guarantee that Spring Batch will not attempt to reprocess each item separately.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="guide-batch-layer.asciidoc_listeners">Listeners</h3>
<div class="paragraph">
<p>Spring Batch provides various listeners for various events to be notified about.</p>
</div>
<div class="paragraph">
<p>For every listener there is an interface which can either be implemented by an ItemReader, ItemProcessor, ItemWriter or Tasklet or by a separate listener class, which can be registered for a step like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">    &lt;batch:tasklet&gt;
        &lt;batch:chunk .../&gt;
        &lt;batch:listeners&gt;
            &lt;batch:listener ref="listener1"/&gt;
            &lt;batch:listener ref="listener2"/&gt;
            ....
        &lt;/batch:listeners&gt;
    &lt;/batch:tasklet&gt;
    &lt;beans:bean id="listener1" class=".."/&gt;
    &lt;beans:bean id="listener2" class=".."/&gt;
    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The most commonly use listener is probably the <code>StepExecutionListener</code>, which has methods that are called before and after the execution of the step. It can be utilized e.g. for opening and closing files.</p>
</div>
<div class="paragraph">
<p>The following example shows how to use the listener:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class MyListener implements StepExecutionListener {

	public void beforeStep(StepExecution stepExecution) {
		// take actions before processing of the step starts
	}

	public ExitStatus afterStep(StepExecution stepExecution) {
		try {
			// take actions after processing is finished
		} catch (Exception e) {
			stepExecution.addFailureException(e);
			stepExecution.setStatus(BatchStatus.FAILED);
			return ExitStatus.FAILED.addExitDescription(e);
		}
		return null;
	}

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the <code>afterStep(StepExecution)</code> method, you can check the outcome of the batch execution (completed, failed, stopped etc.) checking the <code>ExitStatus</code>, which can be accessed via <code>StepExecution.getExitStatus()</code>. You can even modify the <code>ExitStatus</code> by returning a new <code>ExitStatus</code>, which is something we will not discuss in further detail here. If you do not want to modify the <code>ExitStatus</code>, just return null.</p>
</div>
<div class="paragraph">
<p>Throwing an exception in this method has no effect. If you want to fail the whole batch in case an exception occurs, you have to do an exception handling as shown above. This does not apply to the <code>beforeStep</code> method.</p>
</div>
<div class="paragraph">
<p>For other types of listeners (among others the <code>SkipListener</code> mentioned already) see <a href="http://docs.spring.io/spring-batch/reference/html/configureStep.html#interceptingStepExecution">Spring Batch Reference Documentation - 5. Configuring a Step - Intercepting Step Execution</a>.</p>
</div>
<div class="paragraph">
<p>Note that exception handling for listeners is often a problem, because exceptions are mostly ignored, which is not always documented very well. If an important part of a batch is implemented in listener methods, you should always test what happens when exceptions occur. Or you might think about not implementing important things in listeners &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>If you want an exception to fail the whole batch, you can always wrap it in a <code>FatalStepExecutionException</code>, which will stop the execution.</p>
</div>
</div>
<div class="sect2">
<h3 id="guide-batch-layer.asciidoc_parameters">Parameters</h3>
<div class="paragraph">
<p>The section on <a href="#guide-batch-layer.asciidoc_starting-and-stopping-batches">starting and stopping batches</a> already showed how to start a batch with parameters.</p>
</div>
<div class="paragraph">
<p>One way to get access to the values set is using the <code>StepExecutionListener</code> introduced in the section on <a href="#guide-batch-layer.asciidoc_listeners">listeners</a> like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public void beforeStep(StepExecution stepExecution) {

	String parameterValue = stepExecution.getJobExecution().getJobParameters().
		getString("parameterKey");
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are getter methods for strings, doubles, longs and dates. Note that when set via the <code>CommandLineJobRunner</code> or <code>SpringBootBatchCommandLine</code>, all parameters will be of type string unless the type is specified in brackets after the parameter key, e.g. <code>processUntil(date)=2015/12/31</code>. The parameter key here is <code>processUntil</code>.</p>
</div>
<div class="paragraph">
<p>Another way is to inject values. In order for this to work, the bean has to have step scope, which means there is a new object created for every execution of a batch step. It works like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;bean id="myProcessor" class="...MyItemProcessor" scope="step"&gt;
	&lt;property name="parameter" value="#{jobParameters['parameterKey']}" /&gt;
&lt;bean&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>There has to be an appropriate setter method for the parameter of course.</p>
</div>
<div class="paragraph">
<p>As already mentioned in the section on <a href="#guide-batch-layer.asciidoc_restarts">restarts</a>, a batch that successfully completed with a certain set of parameters cannot be started once more with the same parameters as this would be considered a restart, which is not necessary, because the batch was already finished.</p>
</div>
<div class="paragraph">
<p>So using no parameters for a batch would mean that it can be started until it completes successfully once, which usually does not make much sense.</p>
</div>
<div class="paragraph">
<p>As batches are usually not executed more than once a day, we propose introducing a general <code>date</code> parameter (without time) for all batch executions.</p>
</div>
<div class="paragraph">
<p>It is advisable to add the date parameter automatically in the <code>JobLauncher</code> if it has not been set manually, which can be done as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">private static final String DATE_PARAMETER = "date";

...

if (jobParameters.getDate("DATE_PARAMETER") == null) {

	Date dateWithoutTime = new Date();
	Calendar cal = Calendar.getInstance();
	cal.setTime(dateWithoutTime);
	cal.set(Calendar.HOUR_OF_DAY, 0);
	cal.set(Calendar.MINUTE, 0);
	cal.set(Calendar.SECOND, 0);
	cal.set(Calendar.MILLISECOND, 0);
	dateWithoutTime = cal.getTime();

	jobParameters = new JobParametersBuilder(jobParameters).addDate(
		DATE_PARAMETER, dateWithoutTime).toJobParameters();

	... // using the jobParametersIncrementer as shown above
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Keep in mind that you might need to set the date parameter explicitly for restarts. Also note that automatically setting the date parameter can be problematic if a batch is sometimes started before and sometimes after midnight, which might result in a batch not being executed (as it has already been executed with the same parameters), so at least for productive systems you should always set it explicitly.</p>
</div>
<div class="paragraph">
<p>The date parameters can also be useful for controlling the business logic, e.g. a batch can process all data that was created until the current date (as set in the date parameter), thereby giving a chance to control how much is actually processed.</p>
</div>
<div class="paragraph">
<p>If your batch has to run more than once a day you could easily adapt the concept of timestamps. If you are using an external batch scheduler, they often provide a counter for the execution and you might automatically pass this instead of the date parameter.</p>
</div>
</div>
<div class="sect2">
<h3 id="guide-batch-layer.asciidoc_performance-tuning">Performance Tuning</h3>
<div class="paragraph">
<p>Most important for performance are of course the algorithms that you write and how fast (and scalable) these are, which is the same as for client processing. Apart from that, the performance of batches is usually closely related to the performance of the database system.</p>
</div>
<div class="paragraph">
<p>If you are retrieving information from the database, you can have one complex query executed in the <code>ItemReader</code> (via a DAO) retrieving all the information needed for the current set of items, or you can execute further queries in the <code>ItemProcessor</code> (or <code>ItemWriter</code>) on a per item basis to retrieve further information.</p>
</div>
<div class="paragraph">
<p>The first approach is usually by far more performant, because there is an overhead for every query being executed and this approach results in less queries being executed. Note that there is a tradeoff between performance and maintainability here. If you put everything into the query executed by an <code>ItemReader</code>, this query can get quite complex.</p>
</div>
<div class="paragraph">
<p>Using cursors instead of pagination as described in the section on <a href="#guide-batch-layer.asciidoc_itemreader">ItemReaders</a> can result in a better performance for the same reason: When using a cursor, the query is only executed once, when using pagination, the query is usually executed once per chunk. You could of course manually cache items, however this easily leads to a high memory consumption.</p>
</div>
<div class="paragraph">
<p>Further possibilities for optimizations are query (plan) optimization and adding missing database indexes.</p>
</div>
</div>
<div class="sect2">
<h3 id="guide-batch-layer.asciidoc_testing">Testing</h3>
<div class="paragraph">
<p>The Section <a href="#guide-testing.asciidoc">Testing</a> covers how to unit and integration test in detail. Therefore we focus here on testing batches.</p>
</div>
<div class="paragraph">
<p>In order for the unit test to run a batch job the unit test class must extend the <code>AbstractSpringBatchIntegrationTest</code> class. Annotation used to load the job&#8217;s <code>ApplicationContext</code>:</p>
</div>
<div class="paragraph">
<p><code>@SpringBootTest(classes = {&#8230;&#8203;})</code>: Indicates which JavaConfig classes (attribute <code>classes</code>)
<code>@ImportResource("classpath:../sample_BatchContext.xml") : Indicates XML files that contain the `ApplicationContext</code>. Use <code>@ContextConfiguration(&#8230;&#8203;)</code> if Spring Boot is not used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public abstract class AbstractSpringBatchIntegrationTest extends AbstractComponentTest {..}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@SpringBootTest(classes = { SpringBootBatchApp.class }, webEnvironment = WebEnvironment.RANDOM_PORT)
@ImportResource("classpath:config/app/batch/beans-productimport.xml")
@EnableAutoConfiguration
public class ProductImportJobTest extends AbstractSpringBatchIntegrationTest {..}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="guide-batch-layer.asciidoc_testing-batch-jobs">Testing Batch Jobs</h4>
<div class="paragraph">
<p>For testing the complete run of a batch job from beginning to end involves following steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>set up a test condition</p>
</li>
<li>
<p>execute the job</p>
</li>
<li>
<p>verify the end result.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The test method below begins by setting up the database with test data. The test then launches the Job using the <code>launchJob()</code> method. The <code>launchJob()</code> method is provided by the <code>JobLauncherTestUtils</code> class.</p>
</div>
<div class="paragraph">
<p>Also provided by the utils class is <code>launchJob(JobParameters)</code>, which allows the test to give particular parameters. The <code>launchJob()</code> method returns the <code>JobExecution</code> object which is useful for asserting particular information about the Job run. In the case below, the test verifies that the Job ended with <code>ExitStatus</code> <code>COMPLETED</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@SpringBootTest(classes = { SpringBootBatchApp.class }, webEnvironment = WebEnvironment.RANDOM_PORT)
@ImportResource("classpath:config/app/batch/beans-productimport.xml")
@EnableAutoConfiguration
public class ProductImportJobTest extends AbstractSpringBatchIntegrationTest {

  @Inject
  private Job productImportJob;

  @Test
  public void testJob() throws Exception {
    ......
    ......
    JobExecution jobExecution = getJobLauncherTestUtils(this.productImportJob).launchJob(jobParameters);
    assertThat(jobExecution.getStatus()).isEqualTo(BatchStatus.COMPLETED);
    ......
    ......
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that when using the <code>launchJob()</code> method, the batch execution will never be considered as a restart (i.e. it will always start from scratch). This is achieved by adding a unique (random) parameter.</p>
</div>
<div class="paragraph">
<p>This is not true for the method <code>launchJob(JobParameters)</code> however, which will result in an exception if the test is executed twice or a batch is executed in two different tests with the same parameters.</p>
</div>
<div class="paragraph">
<p>We will add methods for appropriately handling this situation in future releases of devonfw. Until then you can help yourself by using the method <code>getUniqueJobParameters()</code> and then add all required parameters to those parameters returned by the method (as shown in the section on <a href="#guide-batch-layer.asciidoc_parameters">parameters</a>).</p>
</div>
<div class="paragraph">
<p>Also note that even if skips occurred, the BatchStatus is still COMPLETED. That is one reason why you should always check whether the batch did what it was supposed to do or not.</p>
</div>
<div class="sect4">
<h5 id="guide-batch-layer.asciidoc_testing-individual-steps">Testing Individual Steps</h5>
<div class="paragraph">
<p>For complex batch jobs individual steps can be tested. For example to test a <code>createCsvFile</code>, run just that particular Step. This approach allows for more targeted tests by allowing the test to set up data for just that step and to validate its results directly.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">JobExecution jobExecution = getJobLauncherTestUtils(this.billExportJob).launchStep(“createCsvFile”);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="guide-batch-layer.asciidoc_validating-output-files">Validating Output Files</h5>
<div class="paragraph">
<p>When a batch job writes to the database, it is easy to query the database to verify the output. To facilitate the verification of output files Spring Batch provides the class <code>AssertFile</code>. The method <code>assertFileEquals</code> takes two File objects and asserts, line by line, that the two files have the same content. Therefore, it is possible to create a file with the expected output and to compare it to the actual result:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">private static final String EXPECTED_FILE = "classpath:expected.csv";
private static final String OUTPUT_FILE = " file:./temp/output.csv";
AssertFile.assertFileEquals(new FileSystemResource(EXPECTED_FILE), new FileSystemResource(OUTPUT_FILE));</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="guide-batch-layer.asciidoc_testing-restarts">Testing Restarts</h5>
<div class="paragraph">
<p>Simulating an exception at an arbitrary method in the code can be done relatively easy using <a href="https://eclipse.org/aspectj/">AspectJ</a>. Afterwards you should restart the batch and check if the outcome is still correct.</p>
</div>
<div class="paragraph">
<p>Note that when using the <code>launchJob()</code> method, the batch is always started from the beginning (as already mentioned). Use the <code>launchJob(JobParameters)</code> instead with the same parameters for the initial (failing) execution and for the restart.</p>
</div>
<div class="paragraph">
<p>Test your code thoroughly. There should be at least one restart test for every step of the batch job.</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2019-09-24 11:34:31 UTC
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>